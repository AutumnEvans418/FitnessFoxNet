@page "/"
@using FitnessFox.Data.Goals
@using FitnessFox.Data.Vitals

@attribute [Authorize]
@inject ApplicationDbContext dbContext
@inject AuthenticationStateProvider stateProvider
@inject ISnackbar Snackbar

<PageTitle>Home</PageTitle>
<MudGrid>
    <MudItem xs="12" sm="12" md="12">
        <MudPaper Elevation="2" Class="pa-4" Style="height: 100px;">
            <MudText Typo="Typo.h6">Current Date</MudText>
            <MudStack Row=true>
                <MudIconButton OnClick="() => SetDate(CurrentDate?.AddDays(-1))" Icon="@Icons.Material.Filled.ArrowLeft"></MudIconButton>
                <MudDatePicker @bind-Date="CurrentDate" @bind-Date:after="Refresh"></MudDatePicker>
                <MudIconButton OnClick="() => SetDate(CurrentDate?.AddDays(1))" Icon="@Icons.Material.Filled.ArrowRight"></MudIconButton>
            </MudStack>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="4">
        <MudPaper Elevation="2" Class="pa-4">
            <MudText Typo="Typo.h6">Weight</MudText>
            <MudStack Row=true>
                <MudNumericField T="float" @bind-Value="Weight.Value" @bind-Value:after="() => Save(Weight)" Label="Weight"></MudNumericField>
                @if (User.HeightInches > 0)
                {
                    <MudText Align="Align.Center">BMI @Extensions.Bmi(Weight.Value, User.HeightInches)</MudText>
                }
                @if (WeightGoal != null)
                {
                    <MudText Align="Align.Center">Goal Weight: @WeightGoal.Value (@MathF.Round(Weight.Value - WeightGoal.Value)lbs to go)</MudText>
                }

            </MudStack>
            <MudTextField T="string" @bind-Value="Weight.Notes" @bind-Value:after="() => Save(Weight)" Label="Notes"></MudTextField>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="4">
        <MudPaper Elevation="2" Class="pa-4">
            <MudText Typo="Typo.h6">Blood</MudText>
            <MudStack Row=true>
                <MudNumericField T="float" @bind-Value="Systolic.Value" @bind-Value:after="() => Save(Systolic)" Label="Systolic"></MudNumericField>
                <MudNumericField T="float" @bind-Value="Diastolic.Value" @bind-Value:after="() => Save(Diastolic)" Label="Diastolic"></MudNumericField>
                <MudNumericField T="float" @bind-Value="Bpm.Value" @bind-Value:after="() => Save(Bpm)" Label="Bpm"></MudNumericField>
            </MudStack>
            <MudTextField T="string" @bind-Value="Systolic.Notes" @bind-Value:after="() => Save(Systolic)" Label="Notes"></MudTextField>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="4">
        <MudPaper Elevation="2" Class="pa-4">
            <MudText Typo="Typo.h6">Temperature</MudText>
            <MudNumericField T="float" @bind-Value="Temperature.Value" @bind-Value:after="() => Save(Temperature)" Label="Temp"></MudNumericField>
            <MudTextField T="string" @bind-Value="Temperature.Notes" @bind-Value:after="() => Save(Temperature)" Label="Notes"></MudTextField>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="4">
        <MudPaper Elevation="2" Class="pa-4">
            <MudText Typo="Typo.h6">Water</MudText>
            <MudNumericField T="float" @bind-Value="Water.Value" @bind-Value:after="() => Save(Water)" Label="Water (fl ounces)"></MudNumericField>
            <MudTextField T="string" @bind-Value="Water.Notes" @bind-Value:after="() => Save(Water)" Label="Notes"></MudTextField>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="4">
        <MudPaper Elevation="2" Class="pa-4">
            <MudText Typo="Typo.h6">Height</MudText>
            <MudNumericField T="float" @bind-Value="User.HeightInches" @bind-Value:after="() => dbContext.SaveChangesAsync()" Label="Height Inches"></MudNumericField>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    public DateTime? CurrentDate { get; set; } = DateTime.Now;

    public List<UserVital> Vitals { get; set; } = new();

    public UserVital Weight { get; set; } = new();
    public UserVital Systolic { get; set; } = new();
    public UserVital Diastolic { get; set; } = new();
    public UserVital Bpm { get; set; } = new();
    public UserVital Temperature { get; set; } = new();
    public UserVital Water { get; set; } = new();

    public ApplicationUser User { get; set; } = new();

    public UserGoal? WeightGoal { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        await Refresh();

        await base.OnAfterRenderAsync(firstRender);
    }

    public async Task Refresh()
    {
        var user = await stateProvider.GetAuthenticationStateAsync();

        var userId = user.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (userId == null)
            return;

        User = await dbContext.Users.FirstAsync(u => u.Id == userId);

        var currentDate = CurrentDate.GetValueOrDefault().Date;

        Vitals = await dbContext.UserVitals
            .Where(u => u.User.Id == userId)
            .Where(u => u.DateCreated.Date == currentDate)
            .ToListAsync();

        var goals = await dbContext.UserGoals.Where(u => u.UserId == userId).ToListAsync();

        WeightGoal = goals.FirstOrDefault(g => g.Type == UserGoalType.WeightLbs);

        UserVital getType(UserVitalType type)
        {
            return Vitals.FirstOrDefault(v => v.Type == type) ?? new()
            {
                UserId = userId,
                Type = type,
            };
        }

        Weight = getType(UserVitalType.Weight);
        Systolic = getType(UserVitalType.Systolic);
        Diastolic = getType(UserVitalType.Diastolic);
        Bpm = getType(UserVitalType.Bpm);
        Temperature = getType(UserVitalType.Temperature);
        Water = getType(UserVitalType.Water);

        StateHasChanged();
    }

    public async Task SetDate(DateTime? date)
    {
        CurrentDate = date;
        await Refresh();
    }

    public async Task Save(params UserVital[] vitals)
    {
        foreach (var item in vitals)
        {
            dbContext.Update(item);
        }
        await dbContext.SaveChangesAsync();
        Snackbar.Add("Saved");
        StateHasChanged();
    }

}