@page "/foods/add"
@page "/foods/{id:int}"
@attribute [Authorize]
@inject ApplicationDbContext dbContext
@inject AuthenticationStateProvider stateProvider
@inject ISnackbar Snackbar
@inject NavigationManager navigationManager
@inject IJSRuntime jsRuntime
<EditForm Model="Model" OnSubmit="Submit" FormName="Food1">
    <DataAnnotationsValidator />

    <MudPaper Class="p-2 mb-2 mt-2">
        <MudTextField Class="mb-2" T="string" @bind-Value="Model!.BrandRestaurant" Label="Brand/Restaurant" Required=true></MudTextField>
        <MudTextField Class="mb-2" T="string" @bind-Value="Model!.Description" Label="Description/Food Name" Required=true></MudTextField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.ServingSize" Label="Serving Size" Required=true></MudNumericField>
        <MudAutocomplete Class="mb-2" T="string" CoerceValue=true Label="Serving Size Units" Clearable="true" SearchFunc="Search" @bind-Value="Model!.ServingUnit" ></MudAutocomplete>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.TotalServings" Label="Total Servings in Container" Required=true></MudNumericField>
    </MudPaper>

    <MudPaper Class="p-2 mb-2">

        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.Calories" Label="Calories"></MudNumericField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.TotalFat" Label="Total Fat"></MudNumericField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.SaturatedFat" Label="Saturated Fat"></MudNumericField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.PolysaturatedFat" Label="Polysaturated Fat"></MudNumericField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.MonosaturatedFat" Label="Monosaturated Fat"></MudNumericField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.TransFat" Label="Trans Fat"></MudNumericField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.Cholesterol" Label="Cholesterol"></MudNumericField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.Sodium" Label="Sodium"></MudNumericField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.Potassium" Label="Potassium"></MudNumericField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.Carbs" Label="Carbs"></MudNumericField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.Fiber" Label="Fiber"></MudNumericField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.Sugar" Label="Sugar"></MudNumericField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.Protein" Label="Protein"></MudNumericField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.VitaminA" Label="Vitamin A"></MudNumericField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.VitaminC" Label="Vitamin C"></MudNumericField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.Calcium" Label="Calcium"></MudNumericField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.Iron" Label="Iron"></MudNumericField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.VitaminK" Label="Vitamin K"></MudNumericField>

    </MudPaper>

    <MudButton Class="mb-4" Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit">Submit</MudButton>
</EditForm>

@code {
    [SupplyParameterFromForm]
    public Food? Model { get; set; }

    [Parameter]
    public int? Id { get; set; }

    public List<string> Units { get; set; } = [];

    protected override async Task OnInitializedAsync()
    {
        if (Id != null)
        {
            Model = await dbContext.Foods.FirstAsync(f => f.Id == Id);
        }
        Model ??= new();

        Units = await dbContext.Foods.Select(f => f.ServingUnit).Distinct().ToListAsync();
    }

    public async Task Submit()
    {
        if (Model == null)
            return;

        var user = await stateProvider.GetAuthenticationStateAsync();

        var userId = user.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (userId == null)
            return;

        Model.UserId = userId;

        dbContext.Foods.Update(Model);
        await dbContext.SaveChangesAsync();
        await jsRuntime.InvokeVoidAsync("history.back");
    }

    private async Task<IEnumerable<string>> Search(string value, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Units;

        return Units.Where(u => u.Contains(value, StringComparison.InvariantCultureIgnoreCase)).ToList();
    }
}
