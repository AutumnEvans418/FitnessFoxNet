@page "/recipes/add"
@page "/recipes/{id}"
@using FitnessFox.Components.ViewModels.Foods
@using FitnessFox.Data.Foods
@attribute [Authorize]
@inherits ViewModelComponentBase<AddRecipeViewModel>

<EditForm Model="Model" OnSubmit="m => Vm.Load(Vm.Submit)" FormName="Recipe1">
    <DataAnnotationsValidator />

    <MudPaper Class="p-2 mb-2 mt-2">
        <MudTextField Class="mb-2" T="string" @bind-Value="Model!.Name" Label="Name" Required=true></MudTextField>
        <MudNumericField Class="mb-2" T="float" @bind-Value="Model!.NumberOfPeople" @bind-Value:after="Vm.IngredientUpdated" Label="Number of People" Required=true></MudNumericField>
    </MudPaper>

    <MudPaper Class="p-2 mb-2">

        <MudTable Items="Model!.Foods" Context="food" CanCancelEdit=true RowEditCommit="i => Vm.IngredientUpdated()">
            <ToolBarContent>
                <MudText>Ingredients</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Add" OnClick="() => Model!.Foods.Add(new())"></MudIconButton>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Food</MudTh>
                <MudTh>Amount</MudTh>
                <MudTh>Total Calories</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@food.Food?.Name</MudTd>
                <MudTd>@food.Amount (@food.ServingUnitDisplay)</MudTd>
                <MudTd>@MathF.Round((food.Food?.Calories ?? 0) * food.Amount, 2)</MudTd>
            </RowTemplate>
            <RowEditingTemplate>
                <MudTd>
                    <MudAutocomplete T="Food"
                                     @bind-Value="@food.Food"
                                     SearchFunc="Vm.Search"
                                     Variant="Variant.Outlined"
                                     Label="Meal"
                                     Clearable></MudAutocomplete>
                    <MudIconButton Color="Color.Primary" Variant="Variant.Filled" Icon="@Icons.Material.Filled.Edit" Href="@($"/foods/{food.FoodId}")"></MudIconButton>

                </MudTd>
                <MudTd>
                    <MudNumericField T="float"
                                     @bind-Value="food.Amount"
                                     Label="Servings"></MudNumericField> (@food.ServingUnitDisplay)
                </MudTd>
            </RowEditingTemplate>
        </MudTable>
    </MudPaper>

    <MudPaper Class="p-2 mb-2">
        <MudText>Per Serving Nutrition Facts</MudText>

        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.Calories" Label="Calories"></MudNumericField>
        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.TotalFat" Label="Total Fat"></MudNumericField>
        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.SaturatedFat" Label="Saturated Fat"></MudNumericField>
        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.PolysaturatedFat" Label="Polysaturated Fat"></MudNumericField>
        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.MonosaturatedFat" Label="Monosaturated Fat"></MudNumericField>
        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.TransFat" Label="Trans Fat"></MudNumericField>
        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.Cholesterol" Label="Cholesterol"></MudNumericField>
        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.Sodium" Label="Sodium"></MudNumericField>
        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.Potassium" Label="Potassium"></MudNumericField>
        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.Carbs" Label="Carbs"></MudNumericField>
        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.Fiber" Label="Fiber"></MudNumericField>
        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.Sugar" Label="Sugar"></MudNumericField>
        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.Protein" Label="Protein"></MudNumericField>
        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.VitaminA" Label="Vitamin A"></MudNumericField>
        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.VitaminC" Label="Vitamin C"></MudNumericField>
        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.Calcium" Label="Calcium"></MudNumericField>
        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.Iron" Label="Iron"></MudNumericField>
        <MudNumericField ReadOnly=true Class="mb-2" T="float" @bind-Value="Model!.VitaminK" Label="Vitamin K"></MudNumericField>

    </MudPaper>

    <MudButton Class="mb-4" Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit">Submit</MudButton>
</EditForm>

@code {
    [SupplyParameterFromForm]
    public Recipe? Model { get => Vm.Model; set => Vm.Model = value; }

    [Parameter]
    public string? Id { get; set; }

    protected override void OnInitialized()
    {
        Vm.Id = Id;
        base.OnInitialized();
    }
}
